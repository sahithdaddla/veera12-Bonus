<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bonus Proposal Form</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: #2c3e50;
      line-height: 1.6;
      background-color: #f5f7fa;
    }

    header {
      background: linear-gradient(135deg, #3498db, #2c3e50);
      color: white;
      text-align: center;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 600;
    }

    header p {
      margin: 5px 0 0;
      font-size: 1rem;
      font-style: italic;
    }

    .container {
      width: 1100px;
      margin: 0 auto;
      padding: 20px;
    }

    .form-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      max-width: 800px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-left: auto;
      margin-right: auto;
      display: none;
    }

    .form-section.active {
      display: block;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      word-break: break-word;
    }

    label {
      font-weight: 600;
      color: #2c3e50;
      display: block;
      margin-bottom: 5px;
    }

    .required-field label::after {
      content: " *";
      color: #e74c3c;
      font-size: 1.1em;
    }

    input, textarea {
      width: 98%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.3s;
    }

    input[readonly] {
      background-color: #f8f9fa;
      cursor: not-allowed;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
    }

    .error-message {
      font-size: 0.85rem;
      color: #e74c3c;
      margin-top: 5px;
      display: block;
    }

    .limit-message {
      font-size: 0.85rem;
      color: #7f8c8d;
      margin-top: 5px;
      display: block;
    }

    .button-group {
      display: flex;
      gap: 15px;
    }

    .submit-btn, .close-btn, .form-toggle-btn {
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .submit-btn, .form-toggle-btn {
      background: linear-gradient(135deg, #3498db, #2c3e50);
      color: white;
    }

    .submit-btn:hover, .form-toggle-btn:hover {
      background: linear-gradient(135deg, #2c3e50, #3498db);
      transform: translateY(-2px);
    }

    .close-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    .close-btn:hover {
      background: linear-gradient(135deg, #c0392b, #e74c3c);
      transform: translateY(-2px);
    }

    .recent-bonus-section {
      max-width: 1000px;
      margin: 0 auto;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .section-header h2 {
      color: #3498db;
      margin: 0;
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .section-header h2::before {
      content: "";
      display: inline-block;
      width: 5px;
      height: 24px;
      background-color: #3498db;
      margin-right: 12px;
      border-radius: 3px;
    }

    .button-container {
      display: flex;
      gap: 10px;
    }

    #recentBonuses {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 500px;
      overflow-y: auto;
      padding: 5px;
    }

    .recent-bonus {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      width: 310px;
      box-sizing: border-box;
      height: 220px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .bonus-details {
      padding: 0;
      flex-grow: 1;
      overflow-y: auto;
    }

    .detail-row {
      display: grid;
      grid-template-columns: 1fr 1.2fr;
      margin-bottom: 8px;
      word-break: break-word;
      font-size: 14px;
    }

    .detail-label {
      color: #7f8c8d;
      font-weight: 500;
    }

    #recentBonuses::-webkit-scrollbar,
    .bonus-details::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    #recentBonuses::-webkit-scrollbar-track,
    .bonus-details::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    #recentBonuses::-webkit-scrollbar-thumb,
    .bonus-details::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }

    #recentBonuses::-webkit-scrollbar-thumb:hover,
    .bonus-details::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    @media (max-width: 768px) {
      .container {
        width: 100%;
        padding: 0 15px 30px 0;
      }

      .form-section, .recent-bonus-section {
        max-width: 100%;
        padding: 20px;
      }

      .recent-bonus {
        width: calc(50% - 5px);
      }

      #recentBonuses {
        max-height: none;
        overflow-y: visible;
      }
    }

@media (max-width: 600px) {
  header h1 {
    font-size: 1.5rem;
  }



      .recent-bonus-section {
        padding: 15px;
      }

      .recent-bonus {
        width: 100%;
        height: auto;
      }

      .detail-row {
        font-size: 12px;
      }

      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Bonus Proposal Form</h1>
    <p>"Rewarding excellence, driving performance"</p>
  </header>

  <div class="container">
    <div id="proposalFormSection" class="form-section">
      <form id="proposalForm">
        <div class="form-group required-field">
          <label for="employeeName">Employee Name:</label>
          <input 
            type="text" 
            id="employeeName" 
            name="employeeName" 
            pattern="^[A-Za-z]+( [A-Za-z]+)*$"
            minlength="4"
            maxlength="30"
            title="Employee Name must be 4-30 characters, letters and single spaces only" 
            required
          >
          <span id="employeeNameError" class="error-message"></span>
          <span id="employeeNameLimit" class="limit-message"></span>
        </div>
        
        <div class="form-group required-field">
          <label for="employeeID">Employee ID:</label>
          <input 
            type="text" 
            id="employeeID" 
            name="employeeID" 
            pattern="^ATS0(?!000)\d{3}$" 
            maxlength="7"
            title="Employee ID must be ATS0 followed by 3 digits (e.g., ATS0123)" 
            required
          >
          <span id="employeeIDError" class="error-message"></span>
          <span id="employeeIDLimit" class="limit-message"></span>
        </div>
        
        <div class="form-group required-field">
          <label for="proposalDate">Proposal Date:</label>
          <input 
            type="text" 
            id="proposalDateDisplay" 
            readonly
            placeholder="Select today's date"
          >
          <input 
            type="hidden" 
            id="proposalDate" 
            name="proposalDate" 
            required
          >
          <span id="proposalDateError" class="error-message"></span>
          <span id="proposalDateLimit" class="limit-message"></span>
        </div>
        
        <div class="form-group required-field">
          <label for="bonusAmount">Bonus Amount (₹):</label>
          <input 
            type="number" 
            id="bonusAmount" 
            name="bonusAmount" 
            min="100" 
            max="1000000"
            step="100"
            required 
            title="Bonus amount must be ₹100 to ₹1,000,000"
          >
          <span id="bonusAmountError" class="error-message"></span>
          <span id="bonusAmountLimit" class="limit-message"></span>
        </div>
        
        <div class="form-group required-field">
          <label for="reason">Reason for Bonus:</label>
          <textarea 
            id="reason" 
            name="reason" 
            rows="3" 
            required 
            minlength="10"
            maxlength="150"
            title="Reason must be 10-150 characters, letters, numbers, and basic punctuation"
          ></textarea>
          <span id="reasonError" class="error-message"></span>
          <span id="reasonLimit" class="limit-message"></span>
        </div>
        
        <div class="button-group">
          <button type="submit" class="submit-btn">Submit Proposal</button>
          <button type="button" class="close-btn" onclick="closeForm()">Close</button>
        </div>
      </form>
    </div>

    <div class="recent-bonus-section">
      <div class="section-header">
        <h2 style="color: #3498db;">Recent Bonus Data</h2>
        <div class="button-container">
          <button class="form-toggle-btn" onclick="toggleForm()">New Proposal</button>
        </div>
      </div>
      <div id="recentBonuses"></div>
    </div>
  </div>

  <script>
    // Move toggleForm and closeForm to global scope
    function closeForm() {
      const formSection = document.getElementById('proposalFormSection');
      const proposalForm = document.getElementById('proposalForm');
      const proposalDateInput = document.getElementById('proposalDate');
      const proposalDateDisplay = document.getElementById('proposalDateDisplay');
      const today = new Date();
      const todayISO = today.toISOString().split('T')[0];
      formSection.classList.remove('active');
      document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
      proposalForm.reset();
      proposalDateInput.value = todayISO;
      proposalDateDisplay.value = formatDate(today);
    }

    function toggleForm() {
      const formSection = document.getElementById('proposalFormSection');
      formSection.classList.toggle('active');
      if (!formSection.classList.contains('active')) {
        closeForm();
      }
    }

    // Date formatting function
    function formatDate(date) {
      const options = { day: '2-digit', month: 'short', year: 'numeric' };
      return date.toLocaleDateString('en-GB', options).replace(/ /g, '-');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const proposalForm = document.getElementById('proposalForm');
      const recentBonusesContainer = document.getElementById('recentBonuses');
      const employeeNameInput = document.getElementById('employeeName');
      const employeeIDInput = document.getElementById('employeeID');
      const proposalDateInput = document.getElementById('proposalDate');
      const proposalDateDisplay = document.getElementById('proposalDateDisplay');
      const bonusAmountInput = document.getElementById('bonusAmount');
      const reasonInput = document.getElementById('reason');
      const employeeNameError = document.getElementById('employeeNameError');
      const employeeIDError = document.getElementById('employeeIDError');
      const proposalDateError = document.getElementById('proposalDateError');
      const bonusAmountError = document.getElementById('bonusAmountError');
      const reasonError = document.getElementById('reasonError');

      // Set date input to today
      const today = new Date();
      const todayISO = today.toISOString().split('T')[0];
      proposalDateInput.value = todayISO;
      proposalDateDisplay.value = formatDate(today);

      // Prevent editing of date field (readonly)
      proposalDateDisplay.addEventListener('click', () => {
        proposalDateError.textContent = 'Date is fixed to today';
        setTimeout(() => proposalDateError.textContent = '', 3000);
      });

      // Validate date (ensure it's today)
      function validateDate() {
        if (proposalDateInput.value !== todayISO) {
          proposalDateInput.setCustomValidity('Please select today\'s date');
          proposalDateError.textContent = 'Please select today\'s date';
        } else {
          proposalDateInput.setCustomValidity('');
          proposalDateError.textContent = '';
        }
      }

      // Fetch and render recent bonuses
      async function fetchRecentBonuses() {
        try {
          const response = await fetch('http://localhost:3000/api/bonuses');
          if (!response.ok) throw new Error('Failed to fetch bonuses');
          const bonusProposals = await response.json();
          renderRecentBonuses(bonusProposals);
        } catch (error) {
          console.error('Error fetching bonuses:', error);
          recentBonusesContainer.innerHTML = '<p>Error loading bonus proposals</p>';
        }
      }

      function renderRecentBonuses(bonusProposals) {
        recentBonusesContainer.innerHTML = '';
        bonusProposals.forEach(proposal => {
          const newCard = document.createElement('div');
          newCard.className = 'recent-bonus';
          newCard.innerHTML = `
            <div class="bonus-details">
              <div class="detail-row">
                <span class="detail-label">Employee Name</span>
                <span>${proposal.employee_name}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Employee ID</span>
                <span>${proposal.employee_id}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Proposal Date</span>
                <span>${formatDate(new Date(proposal.proposal_date))}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Bonus Amount</span>
                <span>₹${Number(proposal.bonus_amount).toLocaleString()}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Reason</span>
                <span>${proposal.reason}</span>
              </div>
            </div>
          `;
          recentBonusesContainer.appendChild(newCard);
        });
      }

      fetchRecentBonuses();

      // Input validation
      function handleInputValidation(event) {
        const input = event.target;
        const value = input.value.trim();
        
        // Prevent multiple spaces
        if (event.key === ' ' && value.slice(-1) === ' ') {
          event.preventDefault();
          return;
        }

        // Employee Name validation
        if (input === employeeNameInput) {
          const isValid = /^[A-Za-z]+( [A-Za-z]+)*$/.test(value);
          if (!isValid && value !== '') {
            employeeNameError.textContent = 'Only letters and single spaces allowed';
            input.setCustomValidity('Invalid name format');
          } else if (value.length < 4 && value !== '') {
            employeeNameError.textContent = 'Minimum 4 characters required';
            input.setCustomValidity('Too short');
          } else if (value.length > 30) {
            employeeNameError.textContent = 'Maximum 30 characters allowed';
            input.setCustomValidity('Too long');
          } else {
            employeeNameError.textContent = '';
            input.setCustomValidity('');
          }
        }

        // Employee ID validation
        if (input === employeeIDInput) {
          const isValid = /^ATS0(?!000)\d{3}$/.test(value);
          if (!isValid && value !== '') {
            employeeIDError.textContent = 'Format: ATS0 followed by 3 digits (e.g., ATS0123)';
            input.setCustomValidity('Invalid ID format');
          } else {
            employeeIDError.textContent = '';
            input.setCustomValidity('');
          }
        }

        // Bonus Amount validation
        if (input === bonusAmountInput) {
          const amount = parseInt(value);
          if (value !== '' && (amount < 100 || isNaN(amount))) {
            bonusAmountError.textContent = 'Minimum bonus amount is ₹100';
            input.setCustomValidity('Too low');
          } else if (amount > 1000000) {
            bonusAmountError.textContent = 'Maximum bonus amount is ₹1,000,000';
            input.setCustomValidity('Too high');
          } else {
            bonusAmountError.textContent = '';
            input.setCustomValidity('');
          }
        }

        // Reason validation
        if (input === reasonInput) {
          const isValid = /^[A-Za-z0-9\s.,!?()-]{10,150}$/.test(value) && 
                          !/^[.,!?()-]+$/.test(value);
          if (!isValid && value !== '') {
            reasonError.textContent = 'Letters, numbers, basic punctuation (10-150 characters)';
            input.setCustomValidity('Invalid reason format');
          } else if (value.length < 10 && value !== '') {
            reasonError.textContent = 'Minimum 10 characters required';
            input.setCustomValidity('Too short');
          } else if (value.length > 150) {
            reasonError.textContent = 'Maximum 150 characters allowed';
            input.setCustomValidity('Too long');
          } else if (/^[.,!?()-]+$/.test(value)) {
            reasonError.textContent = 'Reason cannot consist only of punctuation';
            input.setCustomValidity('Invalid content');
          } else {
            reasonError.textContent = '';
            input.setCustomValidity('');
          }
        }
      }

      // Clean up spaces
      function cleanUpSpaces(event) {
        const input = event.target;
        let original = input.value;
        let corrected = original.replace(/\s{2,}/g, ' ').trim();
        if (original !== corrected) {
          input.value = corrected;
        }
        handleInputValidation({ target: input });
      }

      // Attach event listeners
      employeeNameInput.addEventListener('input', handleInputValidation);
      employeeNameInput.addEventListener('blur', cleanUpSpaces);
      
      employeeIDInput.addEventListener('input', async (event) => {
        handleInputValidation(event);
        const employeeID = employeeIDInput.value;
        if (employeeIDInput.validity.valid && employeeID !== '') {
          try {
            const response = await fetch(`http://localhost:3000/api/bonuses/search?employeeID=${employeeID}`);
            if (response.status === 200) {
              employeeIDError.textContent = 'This Employee ID has already been submitted';
              employeeIDInput.setCustomValidity('Duplicate ID');
            } else {
              employeeIDError.textContent = '';
              employeeIDInput.setCustomValidity('');
            }
          } catch (error) {
            console.error('Error checking employee ID:', error);
          }
        }
      });
      employeeIDInput.addEventListener('blur', cleanUpSpaces);

      bonusAmountInput.addEventListener('input', handleInputValidation);
      reasonInput.addEventListener('input', handleInputValidation);
      reasonInput.addEventListener('blur', cleanUpSpaces);

      // Form submission
      proposalForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        cleanUpSpaces({ target: employeeNameInput });
        cleanUpSpaces({ target: employeeIDInput });
        cleanUpSpaces({ target: reasonInput });
        validateDate();

        if (!proposalForm.checkValidity()) {
          if (!employeeNameInput.validity.valid) {
            employeeNameError.textContent = employeeNameInput.validationMessage || 
              'Please enter a valid name (4-30 characters, letters and single spaces)';
          }
          if (!employeeIDInput.validity.valid) {
            employeeIDError.textContent = employeeIDInput.validationMessage || 
              'Please enter a valid Employee ID (ATS0 followed by 3 digits)';
          }
          if (!proposalDateInput.validity.valid) {
            proposalDateError.textContent = 'Please select today\'s date';
          }
          if (!bonusAmountInput.validity.valid) {
            bonusAmountError.textContent = bonusAmountInput.validationMessage || 
              'Bonus amount must be ₹100 to ₹1,000,000';
          }
          if (!reasonInput.validity.valid) {
            reasonError.textContent = reasonInput.validationMessage || 
              'Please enter a valid reason (10-150 characters)';
          }
          return;
        }

        const employeeName = employeeNameInput.value;
        const employeeID = employeeIDInput.value;
        const proposalDate = proposalDateInput.value;
        const bonusAmount = bonusAmountInput.value;
        const reason = reasonInput.value;

        try {
          const response = await fetch('http://localhost:3000/api/bonuses', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ employeeName, employeeID, proposalDate, bonusAmount, reason })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            if (response.status === 400) {
              employeeIDError.textContent = errorData.error;
              return;
            }
            throw new Error('Failed to submit proposal');
          }

          await fetchRecentBonuses();
          proposalForm.reset();
          proposalDateInput.value = todayISO;
          proposalDateDisplay.value = formatDate(today);
          closeForm();
        } catch (error) {
          console.error('Error submitting proposal:', error);
          alert('Failed to submit proposal. Please try again.');
        }
      });
    });
  </script>
</body>
</html>